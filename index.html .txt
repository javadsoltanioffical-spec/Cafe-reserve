<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø±Ø²Ø±Ùˆ Ù…ÛŒØ² Ø§Ø¬Ø±Ø§ÛŒ Ø²Ù†Ø¯Ù‡ Ø¬ÙˆØ§Ø¯</title>

  <!-- Seatchart CSS & JS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/seatchart@0.1.0/dist/seatchart.min.css">
  <script src="https://cdn.jsdelivr.net/npm/seatchart@0.1.0/dist/seatchart.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    body{font-family: sans-serif; margin:24px; line-height:1.6}
    .wrap{max-width:860px;margin:auto}
    .stage{padding:10px;border:1px dashed #ccc;text-align:center;margin-bottom:12px;border-radius:8px}
    .panel{display:grid;gap:12px;margin-top:16px}
    label{font-size:.95rem}
    input,select,button{padding:10px;border:1px solid #ccc;border-radius:8px}
    button{cursor:pointer}
    .legend{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:8px 0}
    .legend span{display:inline-block;padding:6px 10px;border-radius:6px;border:1px solid #ddd}
    .success{background:#eaffea;border:1px solid #9ad89a;padding:10px;border-radius:8px;margin-top:12px;display:none}
    .error{background:#ffeaea;border:1px solid #e09c9c;padding:10px;border-radius:8px;margin-top:12px;display:none}
    footer{margin-top:28px;font-size:.9rem;color:#666}
    .vip-seat{background:#ffd700 !important;} /* Ø±Ù†Ú¯ Ø·Ù„Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ VIP */
  </style>
</head>
<body>
<div class="wrap">
  <h1>Ø±Ø²Ø±Ùˆ Ù…ÛŒØ² Ø§Ø¬Ø±Ø§ÛŒ Ø²Ù†Ø¯Ù‡</h1>
  <div class="stage">Ø³Ù†/Ø§Ø³ØªÛŒØ¬ Ø§ÛŒÙ†Ø¬Ø§Ø³Øª ğŸ¤</div>

  <div id="chart" style="max-width:860px;"></div>

  <div class="legend">
    <span>Ù‚Ø§Ø¨Ù„ Ø±Ø²Ø±Ùˆ: Ù…Ø±Ø¨Ø¹ Ø®Ø§Ù„ÛŒ</span>
    <span>Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù…Ø§: Ù…Ø±Ø¨Ø¹ Ù‡Ø§ÛŒÙ„Ø§ÛŒØª</span>
    <span>Ø±Ø²Ø±ÙˆØ´Ø¯Ù‡: Ù‚ÙÙ„ Ø´Ø¯Ù‡</span>
    <span style="background:#ffd700;padding:6px 10px;border-radius:6px;border:1px solid #ddd;">VIP</span>
  </div>

  <div class="panel">
    <div>
      <label>ØªØ§Ø±ÛŒØ® Ø§Ø¬Ø±Ø§</label>
      <input id="date" type="date" required>
    </div>
    <div>
      <label>Ø³Ø§Ø¹Øª</label>
      <select id="time">
        <option>19:00</option>
        <option>21:00</option>
      </select>
    </div>
    <div>
      <label>Ù†Ø§Ù… Ùˆ Ù†Ø§Ù…â€ŒØ®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ</label>
      <input id="name" placeholder="Ù…Ø«Ù„Ø§Ù‹ Ø¹Ù„ÛŒ Ø±Ø¶Ø§ÛŒÛŒ">
    </div>
    <div>
      <label>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³</label>
      <input id="phone" placeholder="09xxxxxxxxx">
    </div>
    <div>
      <button id="reserveBtn">Ø«Ø¨Øª Ø±Ø²Ø±Ùˆ</button>
    </div>
    <div class="success" id="okMsg">Ø±Ø²Ø±Ùˆ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯! Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ù¾ÛŒØ§Ù…Ú©/ØªÙ…Ø§Ø³ Ú¯Ø±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
    <div class="error" id="errMsg"></div>
  </div>

  <footer>Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø±Ø²Ø±Ùˆ Ù…ÛŒØ² Ø¨Ø§ Ù†Ù‚Ø´Ù‡ ØªØ¹Ø§Ù…Ù„ÛŒ.</footer>
</div>

<script>
  // 1) ØªÙ†Ø¸ÛŒÙ… Firebase
  const firebaseConfig = {
    apiKey: "YOUR-FIREBASE-CONFIG",
    authDomain: "YOUR-FIREBASE-CONFIG",
    databaseURL: "YOUR-FIREBASE-CONFIG",
    projectId: "YOUR-FIREBASE-CONFIG",
    storageBucket: "YOUR-FIREBASE-CONFIG",
    messagingSenderId: "YOUR-FIREBASE-CONFIG",
    appId: "YOUR-FIREBASE-CONFIG"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // 2) ØªØ¹Ø±ÛŒÙ Ù†Ù‚Ø´Ù‡ Ù…ÛŒØ²Ù‡Ø§
  const seatsData = [
    { id: '1', type: 'default', label:'4 Ù†ÙØ±Ù‡' },
    { id: '2', type: 'default', label:'4 Ù†ÙØ±Ù‡' },
    { id: '3', type: 'default', label:'4 Ù†ÙØ±Ù‡' },
    { id: '4', type: 'default', label:'4 Ù†ÙØ±Ù‡' },
    { id: '5', type: 'default', label:'4 Ù†ÙØ±Ù‡' },
    { id: '6', type: 'default', label:'4 Ù†ÙØ±Ù‡' },
    { id: '7', type: 'default', label:'4 Ù†ÙØ±Ù‡' },
    { id: '8', type: 'default', label:'4 Ù†ÙØ±Ù‡' },
    { id: '9', type: 'default', label:'8 Ù†ÙØ±Ù‡' },
    { id: '10', type: 'default', label:'8 Ù†ÙØ±Ù‡' },
    { id: '11', type: 'vip-seat', label:'VIP 10 Ù†ÙØ±Ù‡' }
  ];

  const chart = new Seatchart(document.getElementById('chart'), {
    map: { rows: [seatsData.slice(0,4), seatsData.slice(4,8), seatsData.slice(8,11)] },
    types: {
      default: { label: 'Ù…ÛŒØ²', cssClass: 'sc-seat' },
      'vip-seat': { label:'VIP', cssClass: 'vip-seat' }
    },
    legend: false,
    seats: { click: true, multiple: true, selected: [] }
  });

  function pathFor(date, time){ return `bookings/${date}/${time}`; }

  async function loadAndLockReserved(){
    const date = document.getElementById('date').value;
    const time = document.getElementById('time').value;
    if(!date) return;

    chart.unselectAll();
    chart.getAll().forEach(seat => seat.enable());

    const snap = await db.ref(pathFor(date,time)).get();
    if(snap.exists()){
      const reserved = Object.keys(snap.val());
      reserved.forEach(id=>{
        const seat = chart.get(id);
        if(seat){ seat.disable(); }
      });
    }
  }

  document.getElementById('date').addEventListener('change', loadAndLockReserved);
  document.getElementById('time').addEventListener('change', loadAndLockReserved);

  document.getElementById('reserveBtn').addEventListener('click', async ()=>{
    const okMsg = document.getElementById('okMsg');
    const errMsg = document.getElementById('errMsg');
    okMsg.style.display = 'none';
    errMsg.style.display = 'none';

    const date = document.getElementById('date').value;
    const time = document.getElementById('time').value;
    const name = document.getElementById('name').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const selected = chart.getSelected().map(s=>s.getId());

    if(!date || !time || !name || !phone || selected.length===0){
      errMsg.textContent = 'Ù„Ø·ÙØ§Ù‹ ØªØ§Ø±ÛŒØ®ØŒ Ø³Ø§Ø¹ØªØŒ Ù†Ø§Ù…ØŒ ØªÙ„ÙÙ† Ùˆ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù…ÛŒØ² Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.';
      errMsg.style.display = 'block';
      return;
    }

    try{
      await Promise.all(selected.map(async id=>{
        const seatRef = db.ref(`${pathFor(date,time)}/${id}`);
        await seatRef.transaction(current=>{
          if(current) return;
          return { name, phone, ts: Date.now() };
        }).then(result=>{
          if(result.committed !== true){
            throw new Error(`Ù…ÛŒØ² ${id} Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù† Ø±Ø²Ø±Ùˆ Ø´Ø¯.`);
          }
        });
      }));

      okMsg.style.display = 'block';
      await loadAndLockReserved();
      chart.unselectAll();
      document.getElementById('name').value='';
      document.getElementById('phone').value='';
    }catch(e){
      errMsg.textContent = e.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø±Ø²Ø±Ùˆ.';
      errMsg.style.display = 'block';
      await loadAndLockReserved();
    }
  });

  document.getElementById('date').value = new Date().toISOString().slice(0,10);
  loadAndLockReserved();
</script>
</body>
</html>